'use strict';$(function(){var e,f,l,k,h=function(){var d=[],a=[],b,c=function(a,b){$.each({removeClass:a,addClass:b},function(a,b){var c=$("#page"+(b-1));c&&c[a]("prev");(c=$("#page"+b))&&c[a]("active");(c=$("#page"+(b+1)))&&c[a]("next")})};return{register:function(b,c,m){d[b]=c;a[b]=m;return this},forward:function(){++b&&$("#back-button").removeClass("donotpresent").off("tap").on("tap",this.backward);d[b]&&d[b]();c(b-1,b);a[b]&&a[b]()},backward:function(){--b||$("#back-button").addClass("donotpresent").off("tap");
d[b]&&d[b]();c(b+1,b);a[b]&&a[b]()},run:function(){b=-1;this.forward()}}}();h.register(0,function(){void 0===document.ontouchmove&&($("#page0 .main-title").text("Device Unsupported"),$("#page0 .explanation").html('Welcome to River Valley High School Science Lab Undertaking Declaration Site. You will need to perform a signature, therefore to use this website, you need a touchscreen. Your device and/or your browser does not support touch. <br>If you are a teacher, please <a href="/admin">login in and visit the administrator console</a>.'),
$("#page0 .interactive-content").empty())},function(){$("#form").off("submit").on("submit",function(){h.forward();return!1})}).register(1,function(){$("#page1 .interactive-content ul").empty()},function(){$.getJSON("/api/classes").done(function(d){$.each(d.data,function(a,b){$("#page1 .interactive-content ul").append($("<li/>").attr("id",b.join("")).text(b.join("")))});$("#page1 .interactive-content ul").off("tap").on("tap","li",function(){e=$(this).attr("id");h.forward();return!1})})}).register(2,
function(){if(!e)throw"No class name";$("#page2 .interactive-content ul").empty()},function(){$.getJSON("/api/classes/"+e).done(function(d){$.each(d.data,function(a,b){$("#page2 .interactive-content ul").append($("<li/>").attr("id","student"+b[0]).text(b[0]+". "+b[1]))});$("#page2 .interactive-content ul").off("tap").on("tap","li",function(){f=$(this).attr("id").slice(7);h.forward();return!1})})}).register(3,function(){if(!e||!f)throw"No class name or index number";},function(){$("#table-class").text(e);
$("#table-index").text(f);var d=function(a){return(a=a.trim().toUpperCase().match(/^(?:[STFG][0-9]{0,3})?[0-9]{4}[JZIHGFEDCBAXWUTRQPNMLK]$/))&&a[0]};$("#submit-nric").off("change").on("change",function(){var a=d($(this).val());$(this)[a?"removeClass":"addClass"]("invalid");a&&$(this).val(a)});$("#form").off("submit").on("submit",function(){var a=d($("#submit-nric").val());a?(l=a,console.log(l),$.getJSON("/api/classes/"+e+"/"+f,{nric:l}).done(function(a){k=a.data;"SubmissionOpen"===k.submission.tag?
h.forward():"SubmissionNotOpen"===k.submission.tag?alert("Submission is not open yet. Check back later."):alert("You have already submitted before. You cannot submit again.")}).fail(function(){alert("The NRIC is incorrect.")})):alert("The NRIC is incorrect.");return!1})}).register(4,function(){if(!e||!f||!l)throw"No class name or index number or nric";},function(){$("#form").off("submit").on("submit",function(){h.forward();return!1})}).register(5,function(){if(!e||!f)throw"No class name or index number";
},function(){$("#table-chinesename").text(k.chinese_name);$.getJSON("/api/subjects").done(function(a){var b=k.subject_combi;console.log(b);$("#table-subjects").text($.map(b,function(b){console.log(_.find(a.data,function(a){return a.id===b}).name);return _.find(a.data,function(a){return a.id===b}).name}).join(", ")||"\u2014")});$.getJSON("/api/ccas").done(function(a){$.each([1,2,3],function(b,c){var d="<select name=cca"+c+">",e=_.flatten(_.map(_.groupBy(a.data,"category"),function(a,b){return[$("<option disabled>"+
b+"</option>")].concat(_.map(a,function(a){return $('<option value="'+a.id+'">'+a.name+"</option>")}))}));e.unshift($("<option>None</option>"));$("#table-cca"+c).empty().append($(d).append(e))})});var d={"#submit-email":function(a){return(a=a.trim().match(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/))&&a[0]},"#submit-phone":function(a){return(a=a.trim().match(/^(?:\+65)? *([0-9]{4}) *([0-9]{4})$/))&&"+65 "+
a.slice(1).join(" ")}};$.each(d,function(a,b){$(a).off("change").on("change",function(){var a=b($(this).val());$(this)[a?"removeClass":"addClass"]("invalid");a&&$(this).val(a)})});$("#form").off("submit").on("submit",function(){var a=!0;$.each(d,function(b,c){return a=a&&!!c($(b).val())});console.log(a);a?h.forward():alert("The email address or phone number is incorrect. Please correct this before continuing.");return!1})}).register(6,function(){if(!e||!f)throw"No class name or index number";$("#page6 .interactive-content .canvas").empty()},
function(){$(document).on("scrollstart",!1);var d=window.devicePixelRatio||1;$("#page6 .interactive-content .canvas").append($("<canvas/>").attr("width",500*d).attr("height",310*d));var a=$("#page6 .interactive-content canvas").get(0),b=a.getContext("2d");b.lineCap="round";b.lineWidth=2*d;var c=[],e=function(a){b.moveTo.apply(b,a[0]);$.each(a.slice(1),function(a,c){b.lineTo.apply(b,c)});b.stroke()},f=function(a,b){b=b||20;var c=[];a.unshift(a[0]);a.concat(a.slice(-1));for(var d=0;d<a.length-4+1;++d){var g=
a.slice(d,d+4);c.push(g[1]);for(var e=1;e<b;++e){var f=e/b;c.push($.map([0,1],function(a){return.5*(2*g[1][a]+(-g[0][a]+g[2][a])*f+(2*g[0][a]-5*g[1][a]+4*g[2][a]-g[3][a])*f*f+(-g[0][a]+3*g[1][a]-3*g[2][a]+g[3][a])*f*f*f)}))}c.push(g[2])}return c};$("#page6").on("webkitTransitionEnd",function(){var b=+$(a).offset().left,h=+$(a).offset().top;$(a).on("touchmove",function(a){var e=(+a.originalEvent.touches[0].pageX-b)*d;a=(+a.originalEvent.touches[0].pageY-h)*d;var f=c.slice(-1)[0]||[-1,-1];f[0]!==e&&
f[1]!==a&&c.push([e,a]);return!1});$(a).on("touchend",function(){c.length&&e(2<c.length?f(c):c);c=[]})});$("#form").off("submit").on("submit",function(){$("#submit-signature").val(a.toDataURL("image/png"));$("#submit-ua").val(navigator.userAgent);$.post("/api/students/"+k.id+"/submit",$(this).serialize(),function(){h.forward()});return!1})}).register(7,function(){$("#back-button").addClass("donotpresent").off("tap")}).run()});
