'use strict';(function(r,w,a){a(function(){function x(c){var d=r.devicePixelRatio||1,b=c.getContext("2d");b.lineCap="round";b.lineWidth=3*d;var e=[],h=!1,t=!1,q=!1,u=r.requestAnimationFrame,k=function(d){t=!0;q||(e.push(e[0]),b.moveTo.apply(b,e[0]),b.beginPath(),q=!0);d&&e.concat(e.slice(-1));if(4>e.length){if(!d)return;h||(b.arc(e[0][0],e[0][1],b.lineWidth,0,2*Math.PI),b.fill())}else for(var c=0;c<e.length-4+1;++c){var f=e.slice(c,c+4);b.lineTo.apply(b,f[1]);for(var k=1;8>k;++k){var m=k/8;b.lineTo.apply(b,
a.map([0,1],function(a){return.5*(2*f[1][a]+(-f[0][a]+f[2][a])*m+(2*f[0][a]-5*f[1][a]+4*f[2][a]-f[3][a])*m*m+(-f[0][a]+3*f[1][a]-3*f[2][a]+f[3][a])*m*m*m)}))}b.lineTo.apply(b,f[2])}b.stroke();b.beginPath();h=!0;d?(b.closePath(),e=[],h=q=!1):e=e.slice(-3)};return{clear:function(){b.clearRect(0,0,c.width,c.height);e=[];t=h=q=!1},hasDrawn:function(){return t},destroyEventListeners:function(){a(c).off("touchstart");a(c).off("touchmove");a(c).off("touchend")},setupEventListeners:function(){var b=+a(c).offset().left,
d=+a(c).offset().top,f=a(c).attr("width")/+a(c).width(),h=function(a){e.push([(+a.originalEvent.touches[0].pageX-b)*f,(+a.originalEvent.touches[0].pageY-d)*f])};a(c).off("touchstart").on("touchstart",function(a){u(function(){h(a);k(!1)});return!1});a(c).off("touchmove").on("touchmove",function(a){u(function(){h(a);k(!1)});return!1});a(c).off("touchend").on("touchend",function(a){u(function(){k(!0)});return!1})}}}var g,n,v,p,l=function(){var c=[],d=[],b,e=function(b,d){a.each({removeClass:b,addClass:d},
function(b,d){var c=a("#page"+(d-1));c&&c[b]("prev");(c=a("#page"+d))&&c[b]("active");(c=a("#page"+(d+1)))&&c[b]("next")})};return{register:function(a,b,e){c[a]=b;d[a]=e;return this},forward:function(){++b&&a("#back-button").removeClass("donotpresent").off("tap").on("tap",this.backward);c[b]&&c[b]();e(b-1,b);d[b]&&d[b]()},backward:function(){--b||a("#back-button").addClass("donotpresent").off("tap");c[b]&&c[b]();e(b+1,b);d[b]&&d[b]()},run:function(){b=-1;this.forward()}}}();l.register(0,function(){void 0===
w.ontouchmove&&(a("#page0 .main-title").text("Device Unsupported"),a("#page0 .explanation").html('Welcome to River Valley High School Science Lab Undertaking Declaration Site. You will need to perform a signature, therefore to use this website, you need a touchscreen. Your device and/or your browser does not support touch. <br>If you are a teacher, please <a href="/admin">login in and visit the administrator console</a>.'),a("#page0 .interactive-content").empty())},function(){a("#form").off("submit").on("submit",
function(){l.forward();return!1})}).register(1,function(){a("#page1 .interactive-content ul").empty()},function(){a.getJSON("/api/classes").done(function(c){a.each(c.data,function(d,b){a("#page1 .interactive-content ul").append(a("<li/>").attr("id",b.join("")).text(b.join("")))});a("#page1 .interactive-content ul").off("tap").on("tap","li",function(){g=a(this).attr("id");l.forward();return!1})})}).register(2,function(){if(!g)throw"No class name";a("#page2 .interactive-content ul").empty()},function(){a.getJSON("/api/classes/"+
g).done(function(c){a.each(c.data,function(d,b){a("#page2 .interactive-content ul").append(a("<li/>").attr("id","student"+b[0]).text(b[0]+". "+b[1]))});a("#page2 .interactive-content ul").off("tap").on("tap","li",function(){n=a(this).attr("id").slice(7);l.forward();return!1})})}).register(3,function(){if(!g||!n)throw"No class name or index number";},function(){a("#table-class").text(g);a("#table-index").text(n);var c=function(a){return(a=a.trim().toUpperCase().match(/^(?:[STFG][0-9]{0,4})?[0-9]{3}[JZIHGFEDCBAXWUTRQPNMLK]$/))&&
a[0]};a("#submit-nric").off("change").on("change",function(){var d=c(a(this).val());a(this)[d?"removeClass":"addClass"]("invalid");d&&a(this).val(d)});a("#form").off("submit").on("submit",function(){var d=c(a("#submit-nric").val());d?(v=d,console.log(v),a.getJSON("/api/classes/"+g+"/"+n,{nric:v}).done(function(a){p=a.data;"SubmissionOpen"===p.submission.tag?l.forward():"SubmissionNotOpen"===p.submission.tag?alert("Submission is not open yet. Check back later."):alert("You have already submitted before. You cannot submit again.")}).fail(function(){alert("The NRIC is incorrect.")})):
alert("The NRIC is incorrect.");return!1})}).register(4,function(){if(!g||!n)throw"No class name or index number";},function(){a("#table-chinesename").text(p.chinese_name);a.getJSON("/api/subjects").done(function(d){var b=p.subject_combi;console.log(b);a("#table-subjects").text(a.map(b,function(a){console.log(_.find(d.data,function(b){return b.id===a}).name);return _.find(d.data,function(b){return b.id===a}).name}).join(", ")||"\u2014")});a.getJSON("/api/ccas").done(function(d){a.each([1,2,3],function(b,
c){var h="<select name=cca"+c+">",g=_.flatten(_.map(_.groupBy(d.data,"category"),function(b,d){return[a("<option disabled>"+d+"</option>")].concat(_.map(b,function(b){return a('<option value="'+b.id+'">'+b.name+"</option>")}))}));g.unshift(a('<option value="">None</option>'));a("#table-cca"+c).empty().append(a(h).append(g))})});var c={"#submit-email":function(a){return(a=a.trim().match(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/))&&
a[0]},"#submit-phone":function(a){return(a=a.trim().match(/^(?:\+65)? *([0-9]{4}) *([0-9]{4})$/))&&"+65 "+a.slice(1).join(" ")}};a.each(c,function(c,b){a(c).off("change").on("change",function(){var c=b(a(this).val());a(this)[c?"removeClass":"addClass"]("invalid");c&&a(this).val(c)})});a("#form").off("submit").on("submit",function(){var d=!0;a.each(c,function(b,c){return d=d&&!!c(a(b).val())});console.log(d);d?l.forward():alert("The email address or phone number is incorrect. Please correct this before continuing.");
return!1})}).register(5,function(){if(!g||!n)throw"No class name or index number";a("#page5 .interactive-content .canvas").empty()},function(){var c=r.devicePixelRatio||1;a("#page5 .interactive-content .canvas").on("scrollstart",!1).append(a("<canvas/>").attr("width",500*c).attr("height",310*c));var d=a("#page5 .interactive-content canvas").get(0),b=x(d);a("#page5").on("scrollstop",b.setupEventListeners).on("webkitTransitionEnd",b.setupEventListeners);a("#form").off("submit").on("submit",function(){b.hasDrawn()?
(a("#submit-signature").val(d.toDataURL("image/png")),a("#submit-ua").val(navigator.userAgent),a.post("/api/students/"+p.id+"/submit",a(this).serialize(),function(){b.destroyEventListeners();l.forward()})):alert("You have not signed yet.");return!1})}).register(6,function(){a("#back-button").addClass("donotpresent").off("tap")}).run()})})(window,document,$);
