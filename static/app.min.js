'use strict';$(function(){var c,g,k,h,f=function(){var e=[],a=[],b,d=function(a,b){$.each({removeClass:a,addClass:b},function(a,b){var d=$("#page"+(b-1));d&&d[a]("prev");(d=$("#page"+b))&&d[a]("active");(d=$("#page"+(b+1)))&&d[a]("next")})};return{register:function(b,d,c){e[b]=d;a[b]=c;return this},forward:function(){++b&&$("#back-button").removeClass("donotpresent").off("tap").on("tap",this.backward);e[b]&&e[b]();d(b-1,b);a[b]&&a[b]()},backward:function(){--b||$("#back-button").addClass("donotpresent").off("tap");
e[b]&&e[b]();d(b+1,b);a[b]&&a[b]()},run:function(){b=-1;this.forward()}}}();f.register(0,function(){void 0===document.ontouchmove&&($("#page0 .main-title").text("Device Unsupported"),$("#page0 .explanation").html('Welcome to River Valley High School Science Lab Undertaking Declaration Site. You will need to perform a signature, therefore to use this website, you need a touchscreen. Your device and/or your browser does not support touch. <br>If you are a teacher, please <a href="/admin">login in and visit the administrator console</a>.'),
$("#page0 .interactive-content").empty())},function(){$("#form").off("submit").on("submit",function(){f.forward();return!1})}).register(1,function(){$("#page1 .interactive-content ul").empty()},function(){$.getJSON("/api/classes").done(function(e){$.each(e.data,function(a,b){$("#page1 .interactive-content ul").append($("<li/>").attr("id",b.join("")).text(b.join("")))});$("#page1 .interactive-content ul").off("tap").on("tap","li",function(){c=$(this).attr("id");f.forward();return!1})})}).register(2,
function(){if(!c)throw"No class name";$("#page2 .interactive-content ul").empty()},function(){$.getJSON("/api/classes/"+c).done(function(e){$.each(e.data,function(a,b){$("#page2 .interactive-content ul").append($("<li/>").attr("id","student"+b[0]).text(b[0]+". "+b[1]))});$("#page2 .interactive-content ul").off("tap").on("tap","li",function(){g=$(this).attr("id").slice(7);f.forward();return!1})})}).register(3,function(){if(!c||!g)throw"No class name or index number";},function(){$("#table-class").text(c);
$("#table-index").text(g);var e=function(a){return(a=a.trim().toUpperCase().match(/^(?:[STFG][0-9]{0,3})?[0-9]{4}[JZIHGFEDCBAXWUTRQPNMLK]$/))&&a[0]};$("#submit-nric").off("change").on("change",function(){var a=e($(this).val());$(this)[a?"removeClass":"addClass"]("invalid");a&&$(this).val(a)});$("#form").off("submit").on("submit",function(){var a=e($("#submit-nric").val());a?(k=a,console.log(k),$.getJSON("/api/classes/"+c+"/"+g,{nric:k}).done(function(a){h=a.data;"SubmissionOpen"===h.submission.tag?
f.forward():"SubmissionNotOpen"===h.submission.tag?alert("Submission is not open yet. Check back later."):alert("You have already submitted before. You cannot submit again.")}).fail(function(){alert("The NRIC is incorrect.")})):alert("The NRIC is incorrect.");return!1})}).register(4,function(){if(!c||!g)throw"No class name or index number";},function(){$("#table-chinesename").text(h.chinese_name);$.getJSON("/api/subjects").done(function(a){var b=h.subject_combi;console.log(b);$("#table-subjects").text($.map(b,
function(b){console.log(_.find(a.data,function(a){return a.id===b}).name);return _.find(a.data,function(a){return a.id===b}).name}).join(", ")||"\u2014")});$.getJSON("/api/ccas").done(function(a){$.each([1,2,3],function(b,d){var e="<select name=cca"+d+">",c=_.flatten(_.map(_.groupBy(a.data,"category"),function(a,b){return[$("<option disabled>"+b+"</option>")].concat(_.map(a,function(a){return $('<option value="'+a.id+'">'+a.name+"</option>")}))}));c.unshift($('<option value="">None</option>'));$("#table-cca"+
d).empty().append($(e).append(c))})});var e={"#submit-email":function(a){return(a=a.trim().match(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/))&&a[0]},"#submit-phone":function(a){return(a=a.trim().match(/^(?:\+65)? *([0-9]{4}) *([0-9]{4})$/))&&"+65 "+a.slice(1).join(" ")}};$.each(e,function(a,b){$(a).off("change").on("change",function(){var a=b($(this).val());$(this)[a?"removeClass":"addClass"]("invalid");a&&
$(this).val(a)})});$("#form").off("submit").on("submit",function(){var a=!0;$.each(e,function(b,d){return a=a&&!!d($(b).val())});console.log(a);a?f.forward():alert("The email address or phone number is incorrect. Please correct this before continuing.");return!1})}).register(5,function(){if(!c||!g)throw"No class name or index number";$("#page5 .interactive-content .canvas").empty()},function(){$(document).on("scrollstart",!1);var e=window.devicePixelRatio||1;$("#page5 .interactive-content .canvas").append($("<canvas/>").attr("width",
500*e).attr("height",310*e));var a=$("#page5 .interactive-content canvas").get(0),b=a.getContext("2d");b.lineCap="round";b.lineWidth=2*e;var d=[],c=!1,g=function(a){b.moveTo.apply(b,a[0]);$.each(a.slice(1),function(a,d){b.lineTo.apply(b,d)});b.stroke();c=!0},k=function(a,b){b=b||20;var d=[];a.unshift(a[0]);a.concat(a.slice(-1));for(var e=0;e<a.length-4+1;++e){var c=a.slice(e,e+4);d.push(c[1]);for(var g=1;g<b;++g){var f=g/b;d.push($.map([0,1],function(a){return.5*(2*c[1][a]+(-c[0][a]+c[2][a])*f+(2*
c[0][a]-5*c[1][a]+4*c[2][a]-c[3][a])*f*f+(-c[0][a]+3*c[1][a]-3*c[2][a]+c[3][a])*f*f*f)}))}d.push(c[2])}return d};$("#page5").on("webkitTransitionEnd",function(){var b=+$(a).offset().left,c=+$(a).offset().top;$(a).on("touchmove",function(a){var f=(+a.originalEvent.touches[0].pageX-b)*e;a=(+a.originalEvent.touches[0].pageY-c)*e;var g=d.slice(-1)[0]||[-1,-1];g[0]!==f&&g[1]!==a&&d.push([f,a]);return!1});$(a).on("touchend",function(){d.length&&g(2<d.length?k(d):d);d=[]})});$("#form").off("submit").on("submit",
function(){c?($("#submit-signature").val(a.toDataURL("image/png")),$("#submit-ua").val(navigator.userAgent),$.post("/api/students/"+h.id+"/submit",$(this).serialize(),function(){f.forward()})):alert("You have not signed yet.");return!1})}).register(6,function(){$("#back-button").addClass("donotpresent").off("tap")}).run()});
