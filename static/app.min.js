'use strict';(function(p,q,a){a(function(){var f,g,m,l,k=function(){var e=[],b=[],c,d=function(b,c){a.each({removeClass:b,addClass:c},function(b,c){var d=a("#page"+(c-1));d&&d[b]("prev");(d=a("#page"+c))&&d[b]("active");(d=a("#page"+(c+1)))&&d[b]("next")})};return{register:function(a,c,d){e[a]=c;b[a]=d;return this},forward:function(){++c&&a("#back-button").removeClass("donotpresent").off("tap").on("tap",this.backward);e[c]&&e[c]();d(c-1,c);b[c]&&b[c]()},backward:function(){--c||a("#back-button").addClass("donotpresent").off("tap");
e[c]&&e[c]();d(c+1,c);b[c]&&b[c]()},run:function(){c=-1;this.forward()}}}();k.register(0,function(){void 0===q.ontouchmove&&(a("#page0 .main-title").text("Device Unsupported"),a("#page0 .explanation").html('Welcome to River Valley High School Science Lab Undertaking Declaration Site. You will need to perform a signature, therefore to use this website, you need a touchscreen. Your device and/or your browser does not support touch. <br>If you are a teacher, please <a href="/admin">login in and visit the administrator console</a>.'),
a("#page0 .interactive-content").empty())},function(){a("#form").off("submit").on("submit",function(){k.forward();return!1})}).register(1,function(){a("#page1 .interactive-content ul").empty()},function(){a.getJSON("/api/classes").done(function(e){a.each(e.data,function(b,c){a("#page1 .interactive-content ul").append(a("<li/>").attr("id",c.join("")).text(c.join("")))});a("#page1 .interactive-content ul").off("tap").on("tap","li",function(){f=a(this).attr("id");k.forward();return!1})})}).register(2,
function(){if(!f)throw"No class name";a("#page2 .interactive-content ul").empty()},function(){a.getJSON("/api/classes/"+f).done(function(e){a.each(e.data,function(b,c){a("#page2 .interactive-content ul").append(a("<li/>").attr("id","student"+c[0]).text(c[0]+". "+c[1]))});a("#page2 .interactive-content ul").off("tap").on("tap","li",function(){g=a(this).attr("id").slice(7);k.forward();return!1})})}).register(3,function(){if(!f||!g)throw"No class name or index number";},function(){a("#table-class").text(f);
a("#table-index").text(g);var e=function(a){return(a=a.trim().toUpperCase().match(/^(?:[STFG][0-9]{0,4})?[0-9]{3}[JZIHGFEDCBAXWUTRQPNMLK]$/))&&a[0]};a("#submit-nric").off("change").on("change",function(){var b=e(a(this).val());a(this)[b?"removeClass":"addClass"]("invalid");b&&a(this).val(b)});a("#form").off("submit").on("submit",function(){var b=e(a("#submit-nric").val());b?(m=b,console.log(m),a.getJSON("/api/classes/"+f+"/"+g,{nric:m}).done(function(a){l=a.data;"SubmissionOpen"===l.submission.tag?
k.forward():"SubmissionNotOpen"===l.submission.tag?alert("Submission is not open yet. Check back later."):alert("You have already submitted before. You cannot submit again.")}).fail(function(){alert("The NRIC is incorrect.")})):alert("The NRIC is incorrect.");return!1})}).register(4,function(){if(!f||!g)throw"No class name or index number";},function(){a("#table-chinesename").text(l.chinese_name);a.getJSON("/api/subjects").done(function(b){var c=l.subject_combi;console.log(c);a("#table-subjects").text(a.map(c,
function(a){console.log(_.find(b.data,function(b){return b.id===a}).name);return _.find(b.data,function(b){return b.id===a}).name}).join(", ")||"\u2014")});a.getJSON("/api/ccas").done(function(b){a.each([1,2,3],function(c,d){var e="<select name=cca"+d+">",f=_.flatten(_.map(_.groupBy(b.data,"category"),function(b,c){return[a("<option disabled>"+c+"</option>")].concat(_.map(b,function(b){return a('<option value="'+b.id+'">'+b.name+"</option>")}))}));f.unshift(a('<option value="">None</option>'));a("#table-cca"+
d).empty().append(a(e).append(f))})});var e={"#submit-email":function(a){return(a=a.trim().match(/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/))&&a[0]},"#submit-phone":function(a){return(a=a.trim().match(/^(?:\+65)? *([0-9]{4}) *([0-9]{4})$/))&&"+65 "+a.slice(1).join(" ")}};a.each(e,function(b,c){a(b).off("change").on("change",function(){var b=c(a(this).val());a(this)[b?"removeClass":"addClass"]("invalid");b&&
a(this).val(b)})});a("#form").off("submit").on("submit",function(){var b=!0;a.each(e,function(c,d){return b=b&&!!d(a(c).val())});console.log(b);b?k.forward():alert("The email address or phone number is incorrect. Please correct this before continuing.");return!1})}).register(5,function(){if(!f||!g)throw"No class name or index number";a("#page5 .interactive-content .canvas").empty()},function(){var e=p.devicePixelRatio||1;a("#page5 .interactive-content .canvas").on("scrollstart",!1).append(a("<canvas/>").attr("width",
500*e).attr("height",310*e));var b=a("#page5 .interactive-content canvas").get(0),c=b.getContext("2d");c.lineCap="round";c.lineWidth=2*e;var d=[],f=!1,g=function(b){c.moveTo.apply(c,b[0]);a.each(b.slice(1),function(a,b){c.lineTo.apply(c,b)});c.stroke();f=!0},m=function(b,c){c=c||20;var d=[];b.unshift(b[0]);b.concat(b.slice(-1));for(var e=0;e<b.length-4+1;++e){var h=b.slice(e,e+4);d.push(h[1]);for(var f=1;f<c;++f){var g=f/c;d.push(a.map([0,1],function(a){return.5*(2*h[1][a]+(-h[0][a]+h[2][a])*g+(2*
h[0][a]-5*h[1][a]+4*h[2][a]-h[3][a])*g*g+(-h[0][a]+3*h[1][a]-3*h[2][a]+h[3][a])*g*g*g)}))}d.push(h[2])}return d},n=function(){var c=+a(b).offset().left,f=+a(b).offset().top,k=500/+a(b).width();a(b).off("touchmove").on("touchmove",function(a){var b=(+a.originalEvent.touches[0].pageX-c)*e*k;a=(+a.originalEvent.touches[0].pageY-f)*e*k;var g=d.slice(-1)[0]||[-1,-1];g[0]!==b&&g[1]!==a&&d.push([b,a]);return!1});a(b).off("touchend").on("touchend",function(){d.length&&g(2<d.length?m(d):d);d=[]})};a("#page5").on("scrollstop",
n).on("webkitTransitionEnd",n);a("#form").off("submit").on("submit",function(){f?(a("#submit-signature").val(b.toDataURL("image/png")),a("#submit-ua").val(navigator.userAgent),a.post("/api/students/"+l.id+"/submit",a(this).serialize(),function(){k.forward()})):alert("You have not signed yet.");return!1})}).register(6,function(){a("#back-button").addClass("donotpresent").off("tap")}).run()})})(window,document,$);
